<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mis casos</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/admin/gestion_usuarios.css">
</head>
<body>
    <div class="menu">
      <div class="menu-logo">
          <img src="../imagenes/logo.png" alt="Logo" />
      </div>

      <div class="menu-item" th:onclick="|window.location.href='@{/admin/inicio}'|">
          <img src="../imagenes/admin_inicio.png" alt="Inicio" />
          <span>Inicio</span>
      </div>

      <div class="menu-item" th:onclick="|window.location.href='@{/admin/gestion_procesos_legales}'|">
          <img src="../imagenes/casos.png" alt="Procesos Legales" />
          <span>Procesos Legales</span>
      </div>

      <div class="menu-item" th:onclick="|window.location.href='@{/admin/gestion_estados}'|">
          <img src="../imagenes/casos.png" alt="Estados de Procesos" />
          <span>Estados de Procesos</span>
      </div>

      <div class="menu-item" th:onclick="|window.location.href='@{/admin/gestion_eventos}'|">
          <img src="../imagenes/casos.png" alt="Audiencias / Eventos" />
          <span>Audiencias / Eventos</span>
      </div>

      <div class="menu-item" th:onclick="|window.location.href='@{/admin/gestion_documentos}'|">
          <img src="../imagenes/casos.png" alt="Documentos" />
          <span>Documentos</span>
      </div>

      <div class="menu-item" th:onclick="|window.location.href='@{/admin/gestion_usuarios}'|">
          <img src="../imagenes/admin_usuario.png" alt="Usuarios" />
          <span>Usuarios</span>
      </div>

      <div class="menu-item" th:onclick="|window.location.href='@{/admin/gestion_roles}'|">
          <img src="../imagenes/admin_usuario.png" alt="Roles" />
          <span>Roles</span>
      </div>

      <div class="menu-item" th:onclick="|window.location.href='@{/admin/gestion_clientes}'|">
          <img src="../imagenes/admin_usuario.png" alt="Clientes" />
          <span>Clientes</span>
      </div>

      <div class="menu-item" th:onclick="|window.location.href='@{/admin/gestion_abogados}'|">
          <img src="../imagenes/admin_usuario.png" alt="Abogados" />
          <span>Abogados</span>
      </div>

      <div class="menu-item activo" th:onclick="|window.location.href='@{/admin/gestion_permisos}'|">
          <img src="../imagenes/admin_usuario.png" alt="Permisos" />
          <span>Permisos</span>
      </div>

      <div class="menu-item" th:onclick="|window.location.href='@{/admin/gestion_notificaciones}'|">
          <img src="../imagenes/admin_comunicacion.png" alt="Notificaciones" />
          <span>Notificaciones</span>
      </div>

      <div class="menu-item" th:onclick="|window.location.href='@{/admin/gestion_observaciones}'|">
          <img src="../imagenes/admin_comunicacion.png" alt="Observaciones" />
          <span>Observaciones</span>
      </div>

      <div class="menu-item" th:onclick="|window.location.href='@{/admin/gestion_chats}'|">
          <img src="../imagenes/admin_comunicacion.png" alt="Chats" />
          <span>Chats</span>
      </div>

      <div class="menu-item" th:onclick="|window.location.href='@{/admin/gestion_ajustes}'|">
          <img src="../imagenes/ajustes.png" alt="Ajustes" />
          <span>Ajustes</span>
      </div>
  </div>

    <div class="encabezado">
      <div class="encabezado-buscar">
        <div class="div-buscar">
          <div class="div-img-buscar">
            <img src="https://img.icons8.com/ios-glyphs/20/999999/search--v1.png" class="img-buscar" alt="Buscar" />
          </div>
          <div class="div-input-buscar">
            <input type="text" placeholder="Buscar..." class="input-buscar" />
          </div>
        </div>
      </div>
      <div class="encabezado-botones">
        <div class="menu-item item-notificacion">
            <img src="../imagenes/notificaciones.png" alt="Notificacion" />
        </div>
        <div class="menu-item item-perfil">
            K
        </div>
      </div>
    </div>

    <div class="div-contenido">

      <div class="div-titulo-seccion">
        <div>
          <h2 class="h2-titulo-seccion">Gestion de permisos</h2>
        </div>
        <div>
          <button class="dt-btn-agregar" id="btn-agregar">+ Agregar</button>
        </div>
      </div>

    <div class="div-tabla-contenido">
        <div class="tabla-scroll">
            <table class="tabla-contenido">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Rol</th>
                        <th>Módulo</th>
                        <th>Acción</th>
                        <th>Permitido</th>
                        <th>Creado Por</th>
                        <th>Fecha Creación</th>
                        <th>Modificado Por</th>
                        <th>Fecha Modificación</th>
                        <th>Eliminado Por</th>
                        <th>Fecha Eliminación</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="permiso : ${permisos}" th:attr="data-id=${permiso.id}">
                        <td th:text="${permiso.id}"></td>
                        <td th:text="${permiso.rol != null ? permiso.rol.nombre : '—'}"></td>
                        <td th:text="${permiso.modulo}"></td>
                        <td th:text="${permiso.accion}"></td>
                        <td th:text="${permiso.permitido ? 'Sí' : 'No'}"></td>
                        <td th:text="${permiso.creadoPor != null ? permiso.creadoPor.nombre + ' ' + permiso.creadoPor.apellido : '—'}"></td>
                        <td th:text="${permiso.fechaCreacion != null ? #temporals.format(permiso.fechaCreacion, 'yyyy-MM-dd HH:mm') : '—'}"></td>
                        <td th:text="${permiso.modificadoPor != null ? permiso.modificadoPor.nombre + ' ' + permiso.modificadoPor.apellido : '—'}"></td>
                        <td th:text="${permiso.fechaModificacion != null ? #temporals.format(permiso.fechaModificacion, 'yyyy-MM-dd HH:mm') : '—'}"></td>
                        <td th:text="${permiso.eliminadoPor != null ? permiso.eliminadoPor.nombre + ' ' + permiso.eliminadoPor.apellido : '—'}"></td>
                        <td th:text="${permiso.fechaEliminacion != null ? #temporals.format(permiso.fechaEliminacion, 'yyyy-MM-dd HH:mm') : '—'}"></td>
                        <td class="acciones">
                          <button class="btn-editar" title="Editar">
                              <img src="../imagenes/editar.png" alt="Editar">
                          </button>
                          <button class="btn-eliminar" title="Eliminar">
                              <img src="../imagenes/eliminar.png" alt="Eliminar">
                          </button>
                      </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- PAGINACIÓN -->
    <div class="paginacion" th:if="${totalPaginas > 0}">
        <a th:if="${paginaActual > 0}"
        th:href="@{/admin/gestion_permisos(pagina=${paginaActual - 1}, tamano=10)}">&laquo; Anterior</a>

        <span th:each="i : ${#numbers.sequence(0, totalPaginas - 1)}">
            <a th:href="@{/admin/gestion_permisos(pagina=${i}, tamano=10)}"
            th:text="${i + 1}"
            th:classappend="${i == paginaActual} ? 'activo' : ''"></a>
        </span>

        <a th:if="${paginaActual < totalPaginas - 1}"
        th:href="@{/admin/gestion_permisos(pagina=${paginaActual + 1}, tamano=10)}">Siguiente &raquo;</a>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
document.addEventListener("DOMContentLoaded", function() {
    document.querySelectorAll(".btn-eliminar").forEach(function(button) {
        button.addEventListener("click", function(event) {
            event.preventDefault();

            let fila = button.closest("tr");
            let idPermiso = fila.getAttribute("data-id"); // ID del permiso
            let rol = fila.querySelector("td:nth-child(2)").innerText; // Rol
            let modulo = fila.querySelector("td:nth-child(3)").innerText; // Módulo
            let accion = fila.querySelector("td:nth-child(4)").innerText; // Acción

            Swal.fire({
                title: "¿Estás seguro?",
                html: `
                    <p>Vas a eliminar el permiso:</p>
                    <b>ID:</b> ${idPermiso}<br>
                    <b>Rol:</b> ${rol}<br>
                    <b>Módulo:</b> ${modulo}<br>
                    <b>Acción:</b> ${accion}
                `,
                icon: "warning",
                showCancelButton: true,
                confirmButtonColor: "#d33",
                cancelButtonColor: "#3085d6",
                confirmButtonText: "Sí, eliminar",
                cancelButtonText: "Cancelar"
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch(`/eliminar_permiso/${idPermiso}`, {
                        method: "DELETE"
                    })
                    .then(response => {
                        if (response.ok) {
                            Swal.fire("Eliminado", "El registro ha sido eliminado.", "success");
                            // Eliminar la fila de la tabla sin recargar la página
                            fila.remove();
                        } else {
                            Swal.fire("Error", "No se pudo eliminar el registro.", "error");
                        }
                    })
                    .catch(() => {
                        Swal.fire("Error", "Hubo un problema de conexión.", "error");
                    });
                }
            });
        });
    });
});
</script>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.22.4"></script>
<script>
'use strict';

const CONFIG = {
    minCaracteres: 1,
    maxCaracteres: 50,
    endpoint: "/admin/guardar_permiso", // POST que guarda permisos
    endpointRoles: "/admin/listar_roles" // GET para obtener los roles
};

const MENSAJES = {
    tituloAgregar: "Agregar nuevo permiso",
    tituloEditar: "Editar permiso",
    moduloObligatorio: "El módulo es obligatorio",
    accionObligatoria: "La acción es obligatoria",
    rolObligatorio: "Debe seleccionar un rol",
    exitoAgregar: "El permiso ha sido agregado correctamente",
    exitoEditar: "El permiso ha sido editado correctamente",
    errorGeneral: "No se pudo guardar el permiso",
    confirmacion: "Guardado"
};

// Genera el contenido HTML del modal
async function generarFormulario(permiso = {}) {
    // Traer los roles desde el backend
    const resp = await fetch(CONFIG.endpointRoles);
    const roles = await resp.json();

    const rolId = permiso.rol ? permiso.rol.id : '';
    const modulo = permiso.modulo || '';
    const accion = permiso.accion || '';
    const permitido = permiso.permitido || false;

    // Crear opciones de select
    const opcionesRoles = roles.map(r => 
        `<option value="${r.id}" ${r.id === rolId ? 'selected' : ''}>${r.nombre}</option>`
    ).join('');

    return `
        <style>
            .etiqueta-swal { display: block; margin-bottom: 5px; font-weight: bold; color: var(--color-secundario, #333); text-align: left; }
            .entrada-swal, select { border-radius: 8px; border: 1px solid #ccc; padding: 8px; margin-bottom: 15px; font-size: 14px; width: 100%; box-sizing: border-box; }
            .contenedor-interruptor { display: flex; align-items: center; gap: 10px; margin-top: 5px; }
            .interruptor { position: relative; display: inline-block; width: 50px; height: 25px; }
            .interruptor input { opacity: 0; width: 0; height: 0; }
            .deslizador { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 25px; }
            .deslizador:before { position: absolute; content: ""; height: 18px; width: 18px; left: 4px; bottom: 3.5px; background-color: white; transition: .4s; border-radius: 50%; }
            input:checked + .deslizador { background-color: var(--color-primario, #4caf50); }
            input:checked + .deslizador:before { transform: translateX(24px); }
        </style>

        <label class="etiqueta-swal">Rol:</label>
        <select id="rolPermiso" name="rol.id"> <!-- Nombre ajustado para @ModelAttribute -->
            <option value="">-- Seleccione un rol --</option>
            ${opcionesRoles}
        </select>

        <label class="etiqueta-swal">Módulo:</label>
        <input id="moduloPermiso" type="text" class="entrada-swal" name="modulo" value="${modulo}" maxlength="${CONFIG.maxCaracteres}">

        <label class="etiqueta-swal">Acción:</label>
        <input id="accionPermiso" type="text" class="entrada-swal" name="accion" value="${accion}" maxlength="${CONFIG.maxCaracteres}">

        <label class="etiqueta-swal">Permitido:</label>
        <div class="contenedor-interruptor">
            <label class="interruptor" role="switch" aria-checked="${permitido}">
                <input id="permitidoPermiso" type="checkbox" name="permitido" ${permitido ? 'checked' : ''}>
                <span class="deslizador"></span>
            </label>
            <span id="textoPermitido">${permitido ? 'Sí' : 'No'}</span>
        </div>
    `;
}

// Configura el interruptor de permitido
function configurarInterruptor() {
    const check = document.getElementById("permitidoPermiso");
    const texto = document.getElementById("textoPermitido");
    if (!check || !texto) return;
    check.addEventListener("change", () => {
        texto.textContent = check.checked ? "Sí" : "No";
        check.parentElement.setAttribute("aria-checked", check.checked);
    });
}

// Extrae datos de una fila de la tabla
function extraerDatosFila(fila) {
    return {
        id: fila.dataset.id,
        rol: { id: parseInt(fila.querySelector('td:nth-child(2)').dataset.rolId) },
        modulo: fila.querySelector('td:nth-child(3)').textContent.trim(),
        accion: fila.querySelector('td:nth-child(4)').textContent.trim(),
        permitido: fila.querySelector('td:nth-child(5)').textContent.trim() === 'Sí'
    };
}

async function enviarPermiso(permiso) {
    const formData = new URLSearchParams();
    if (permiso.id) formData.append("id", permiso.id);
    formData.append("rol.id", permiso.rol.id);
    formData.append("modulo", permiso.modulo);
    formData.append("accion", permiso.accion);
    formData.append("permitido", permiso.permitido);

    const resp = await fetch(CONFIG.endpoint, {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: formData.toString()
    });

    if (!resp.ok) {
        const text = await resp.text();
        if (text.includes("<")) {
            throw new Error("El servidor devolvió un error. Verifica los logs o contacta al administrador.");
        }
        throw new Error(text || MENSAJES.errorGeneral);
    }
    return resp.text(); 
}

// Abre modal de agregar/editar
async function abrirModal(permiso = {}) {
    const esEdicion = Boolean(permiso.id);

    const html = await generarFormulario(permiso);

    const resultado = await Swal.fire({
        title: esEdicion ? MENSAJES.tituloEditar : MENSAJES.tituloAgregar,
        html: html,
        focusConfirm: false,
        showCancelButton: true,
        confirmButtonText: "Guardar",
        cancelButtonText: "Cancelar",
        confirmButtonColor: "var(--color-secundario, #333)",
        cancelButtonColor: "#888",
        showLoaderOnConfirm: true,
        didOpen: configurarInterruptor,
        preConfirm: async () => {
            const rolId = document.getElementById("rolPermiso").value;
            const modulo = document.getElementById("moduloPermiso").value.trim();
            const accion = document.getElementById("accionPermiso").value.trim();
            const permitido = document.getElementById("permitidoPermiso").checked;

            if (!rolId) return Swal.showValidationMessage(MENSAJES.rolObligatorio);
            if (!modulo) return Swal.showValidationMessage(MENSAJES.moduloObligatorio);
            if (!accion) return Swal.showValidationMessage(MENSAJES.accionObligatoria);

            try {
                await enviarPermiso({
                    id: permiso.id,
                    rol: { id: parseInt(rolId) },
                    modulo,
                    accion,
                    permitido
                });
                return true;
            } catch (err) {
                Swal.showValidationMessage(`Error: ${err.message}`);
                return false;
            }
        }
    });

    if (resultado.isConfirmed) {
        await Swal.fire({
            title: MENSAJES.confirmacion,
            text: esEdicion ? MENSAJES.exitoEditar : MENSAJES.exitoAgregar,
            icon: "success",
            timer: 2000,
            showConfirmButton: false
        });
        location.reload();
    }
}

// Inicializa eventos de agregar y editar
function inicializarEventos() {
    const botonAgregar = document.getElementById("btn-agregar");
    if (botonAgregar) botonAgregar.addEventListener("click", () => abrirModal());

    document.querySelectorAll(".btn-editar").forEach(boton => {
        boton.addEventListener("click", e => {
            const fila = e.target.closest("tr");
            if (fila) abrirModal(extraerDatosFila(fila));
        });
    });
}

document.addEventListener("DOMContentLoaded", inicializarEventos);
</script>

    </div>
  </body>
</html>