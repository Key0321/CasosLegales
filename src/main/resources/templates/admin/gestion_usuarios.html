<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mis casos</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/admin/gestion_usuarios.css">
</head>
<body>
    <div class="menu">
      <div class="menu-logo">
          <img src="../imagenes/logo.png" alt="Logo" />
      </div>

      <div class="menu-item" th:onclick="|window.location.href='@{/admin/gestion_procesos_legales}'|">
          <img src="../imagenes/casos.png" alt="Procesos Legales" />
          <span>Procesos Legales</span>
      </div>

      <div class="menu-item" th:onclick="|window.location.href='@{/admin/gestion_estados}'|">
          <img src="../imagenes/casos.png" alt="Estados de Procesos" />
          <span>Estados de Procesos</span>
      </div>

      <div class="menu-item" th:onclick="|window.location.href='@{/admin/gestion_eventos}'|">
          <img src="../imagenes/casos.png" alt="Audiencias / Eventos" />
          <span>Audiencias / Eventos</span>
      </div>

      <div class="menu-item" th:onclick="|window.location.href='@{/admin/gestion_documentos}'|">
          <img src="../imagenes/casos.png" alt="Documentos" />
          <span>Documentos</span>
      </div>

      <div class="menu-item activo" th:onclick="|window.location.href='@{/admin/gestion_usuarios}'|">
          <img src="../imagenes/admin_usuario.png" alt="Usuarios" />
          <span>Usuarios</span>
      </div>

      <div class="menu-item" th:onclick="|window.location.href='@{/admin/gestion_roles}'|">
          <img src="../imagenes/admin_usuario.png" alt="Roles" />
          <span>Roles</span>
      </div>

      <div class="menu-item" th:onclick="|window.location.href='@{/admin/gestion_clientes}'|">
          <img src="../imagenes/admin_usuario.png" alt="Clientes" />
          <span>Clientes</span>
      </div>

      <div class="menu-item" th:onclick="|window.location.href='@{/admin/gestion_abogados}'|">
          <img src="../imagenes/admin_usuario.png" alt="Abogados" />
          <span>Abogados</span>
      </div>

      <div class="menu-item" th:onclick="|window.location.href='@{/admin/gestion_permisos}'|">
          <img src="../imagenes/admin_usuario.png" alt="Permisos" />
          <span>Permisos</span>
      </div>

      <div class="menu-item" th:onclick="|window.location.href='@{/admin/gestion_notificaciones}'|">
          <img src="../imagenes/admin_comunicacion.png" alt="Notificaciones" />
          <span>Notificaciones</span>
      </div>

      <div class="menu-item" th:onclick="|window.location.href='@{/admin/gestion_observaciones}'|">
          <img src="../imagenes/admin_comunicacion.png" alt="Observaciones" />
          <span>Observaciones</span>
      </div>

      <div class="menu-item" th:onclick="|window.location.href='@{/admin/gestion_chats}'|">
          <img src="../imagenes/admin_comunicacion.png" alt="Chats" />
          <span>Chats</span>
      </div>
  </div>

    <div class="encabezado">
      <div class="encabezado-buscar">
        <div class="div-buscar">
          <div class="div-img-buscar">
            <img src="https://img.icons8.com/ios-glyphs/20/999999/search--v1.png" class="img-buscar" alt="Buscar" />
          </div>
          <div class="div-input-buscar">
            <input type="text" placeholder="Buscar..." class="input-buscar" />
          </div>
        </div>
      </div>
      <div class="encabezado-botones">
        <div class="menu-item item-notificacion">
            <img src="../imagenes/notificaciones.png" alt="Notificacion" />
        </div>
        <div class="menu-item item-perfil">
                <span th:text="${#strings.substring(usuarioActual.nombre, 0, 1) + #strings.substring(usuarioActual.apellido, 0, 1)}">US</span>
          </div>
      </div>

      <div class="menu-perfil" id="menuPerfil">
            <div class="perfil-info">
                <div class="perfil-nombre" th:text="${usuarioActual.nombre + ' ' + usuarioActual.apellido}">
                    Nombre Apellido
                </div>
                <div class="perfil-email" th:text="${usuarioActual.correo}">
                    usuario@ejemplo.com
                </div>
            </div>
            <div class="perfil-acciones">
                <button class="btn-cerrar-sesion" onclick="cerrarSesion()">
                    <img th:src="@{/imagenes/cerrar-sesion.png}" alt="Cerrar sesión" />
                    Cerrar sesión
                </button>
            </div>
        </div>
    </div>

    <div class="div-contenido">

      <div class="div-titulo-seccion">
        <div>
          <h2 class="h2-titulo-seccion">Gestion de usuarios</h2>
        </div>
        <div>
          <button class="dt-btn-agregar" th:onclick="|window.location.href='@{/admin/gestion_usuarios_agregar}'|">+ Agregar</button>
        </div>
      </div>

      <div class="div-tabla-contenido">
    <div class="tabla-scroll">
        <table class="tabla-contenido">
            <thead>
                <tr>
                    <th>Conexión</th>
                    <th>Nombre</th>
                    <th>Apellido</th>
                    <th>Tipo ID</th>
                    <th>Identificación</th>
                    <th>Correo</th>
                    <th>Contraseña</th>
                    <th>Teléfono</th>
                    <th>Rol</th>
                    <th>Creado Por</th>
                    <th>Fecha Creación</th>
                    <th>Modificado Por</th>
                    <th>Fecha Modificación</th>
                    <th>Eliminado Por</th>
                    <th>Fecha Eliminación</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                <tr th:each="usuario : ${usuarios}" th:attr="data-id=${usuario.id}">
                    <td class="conexion" 
                        th:attr="data-estado=${ultimoAccesoMap[usuario.id] != null and ultimoAccesoMap[usuario.id].fechaSalida == null} ? 'online' : 'offline',
                                data-fecha-ingreso=${ultimoAccesoMap[usuario.id] != null} ? ${#temporals.format(ultimoAccesoMap[usuario.id].fechaIngreso, 'yyyy-MM-dd HH:mm')} : '',
                                data-fecha-salida=${ultimoAccesoMap[usuario.id] != null and ultimoAccesoMap[usuario.id].fechaSalida != null} ? ${#temporals.format(ultimoAccesoMap[usuario.id].fechaSalida, 'yyyy-MM-dd HH:mm')} : '',
                                data-nombre=${usuario.nombre},
                                data-apellido=${usuario.apellido},
                                data-correo=${usuario.correo},
                                data-rol=${usuario.rol != null} ? ${usuario.rol.nombre} : ''">
                        <span th:if="${ultimoAccesoMap[usuario.id] != null and ultimoAccesoMap[usuario.id].fechaSalida == null}" 
                              class="estado estado-online"></span>
                        <span th:if="${ultimoAccesoMap[usuario.id] == null or ultimoAccesoMap[usuario.id].fechaSalida != null}" 
                              class="estado estado-offline"></span>
                    </td>
                    <td th:text="${usuario.nombre}"></td>
                    <td th:text="${usuario.apellido}"></td>
                    <td th:text="${usuario.tipoIdentificacion}"></td>
                    <td th:text="${usuario.identificacion}"></td>
                    <td th:text="${usuario.correo}"></td>
                    <td th:text="${usuario.contrasenia}"></td>
                    <td th:text="${usuario.telefono}"></td>
                    <td th:text="${usuario.rol != null ? usuario.rol.nombre : '—'}"></td>
                    <td th:text="${usuario.creadoPor != null ? usuario.creadoPor.nombre + ' ' + usuario.creadoPor.apellido : '—'}"></td>
                    <td th:text="${usuario.fechaCreacion != null ? #temporals.format(usuario.fechaCreacion, 'yyyy-MM-dd HH:mm') : '—'}"></td>
                    <td th:text="${usuario.modificadoPor != null ? usuario.modificadoPor.nombre + ' ' + usuario.modificadoPor.apellido : '—'}"></td>
                    <td th:text="${usuario.fechaModificacion != null ? #temporals.format(usuario.fechaModificacion, 'yyyy-MM-dd HH:mm') : '—'}"></td>
                    <td th:text="${usuario.eliminadoPor != null ? usuario.eliminadoPor.nombre + ' ' + usuario.eliminadoPor.apellido : '—'}"></td>
                    <td th:text="${usuario.fechaEliminacion != null ? #temporals.format(usuario.fechaEliminacion, 'yyyy-MM-dd HH:mm') : '—'}"></td>
                    <td class="acciones">
                        <button class="btn-editar" title="Editar">
                            <img src="../imagenes/editar.png" alt="Editar">
                        </button>
                        <button class="btn-eliminar" title="Eliminar">
                            <img src="../imagenes/eliminar.png" alt="Eliminar">
                        </button>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

    <!-- PAGINACIÓN -->
    <div class="paginacion" th:if="${totalPaginas > 0}">
      <a th:if="${paginaActual > 0}"
        th:href="@{/admin/gestion_usuarios(pagina=${paginaActual - 1}, tamano=10)}">&laquo; Anterior</a>

      <span th:each="i : ${#numbers.sequence(0, totalPaginas - 1)}">
          <a th:href="@{/admin/gestion_usuarios(pagina=${i}, tamano=10)}"
            th:text="${i + 1}"
            th:classappend="${i == paginaActual} ? 'activo' : ''"></a>
      </span>

      <a th:if="${paginaActual < totalPaginas - 1}"
        th:href="@{/admin/gestion_usuarios(pagina=${paginaActual + 1}, tamano=10)}">Siguiente &raquo;</a>
  </div> 

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
document.addEventListener("DOMContentLoaded", function() {
    document.querySelectorAll(".btn-eliminar").forEach(function(button) {
        button.addEventListener("click", function(event) {
            event.preventDefault();

            let fila = button.closest("tr");
            let idUsuario = fila.getAttribute("data-id"); // ID del usuario
            let nombre = fila.querySelector("td:nth-child(1)").innerText;
            let apellido = fila.querySelector("td:nth-child(2)").innerText;
            let identificacion = fila.querySelector("td:nth-child(4)").innerText;
            let correo = fila.querySelector("td:nth-child(5)").innerText;

            Swal.fire({
                title: "¿Estás seguro?",
                html: `
                    <p>Vas a eliminar el usuario:</p>
                    <b>Nombre:</b> ${nombre} ${apellido}<br>
                    <b>Identificación:</b> ${identificacion}<br>
                    <b>Correo:</b> ${correo}
                `,
                icon: "warning",
                showCancelButton: true,
                confirmButtonColor: "#d33",
                cancelButtonColor: "#3085d6",
                confirmButtonText: "Sí, eliminar",
                cancelButtonText: "Cancelar"
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch(`/eliminar_usuario/${idUsuario}`, {
                        method: "DELETE"
                    })
                    .then(response => {
                        if (response.ok) {
                            Swal.fire("Eliminado", "El usuario ha sido eliminado.", "success");
                            fila.remove(); // Elimina la fila sin recargar la página
                        } else {
                            Swal.fire("Error", "No se pudo eliminar el usuario.", "error");
                        }
                    })
                    .catch(() => {
                        Swal.fire("Error", "Hubo un problema de conexión.", "error");
                    });
                }
            });
        });
    });
});
</script>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.22.4"></script>
<script>
document.addEventListener("DOMContentLoaded", function() {
    // Código para la columna de Conexión
    document.querySelectorAll(".conexion").forEach(function(cell) {
        cell.addEventListener("click", function(event) {
            event.preventDefault();
            let fila = cell.closest("tr");
            let idUsuario = fila.getAttribute("data-id");
            let estado = cell.getAttribute("data-estado");
            let nombre = cell.getAttribute("data-nombre");
            let apellido = cell.getAttribute("data-apellido");
            let correo = cell.getAttribute("data-correo");
            let rol = cell.getAttribute("data-rol");
            let fechaIngreso = cell.getAttribute("data-fecha-ingreso");
            let fechaSalida = cell.getAttribute("data-fecha-salida");

            if (estado === "online") {
                Swal.fire({
                    title: "Usuario conectado",
                    html: `
                        <p><b>ID:</b> ${idUsuario}</p>
                        <p><b>Nombre:</b> ${nombre}</p>
                        <p><b>Apellido:</b> ${apellido}</p>
                        <p><b>Correo:</b> ${correo}</p>
                        <p><b>Rol:</b> ${rol}</p>
                        <p><b>Fecha de ingreso:</b> ${fechaIngreso || '—'}</p>
                    `,
                    icon: "info",
                    showCancelButton: true,
                    confirmButtonText: "Cerrar sesión",
                    cancelButtonText: "Cerrar",
                    confirmButtonColor: "#d33",
                    cancelButtonColor: "#3085d6"
                }).then((result) => {
                    if (result.isConfirmed) {
                        fetch(`/cerrar_sesion_usuario/${idUsuario}`, {
                            method: "POST"
                        })
                        .then(response => {
                            if (response.ok) {
                                Swal.fire("Sesión cerrada", "La sesión del usuario ha sido cerrada.", "success");
                                // Actualizar el estado en la tabla
                                cell.innerHTML = '<span class="estado estado-offline"></span>';
                                cell.setAttribute("data-estado", "offline");
                            } else {
                                return response.text().then(text => {
                                    throw new Error(text || "No se pudo cerrar la sesión");
                                });
                            }
                        })
                        .catch(error => {
                            Swal.fire("Error", error.message, "error");
                        });
                    }
                });
            } else {
                Swal.fire({
                    title: "Última conexión",
                    html: `
                        <p><b>ID:</b> ${idUsuario}</p>
                        <p><b>Nombre:</b> ${nombre}</p>
                        <p><b>Apellido:</b> ${apellido}</p>
                        <p><b>Última conexión:</b></p>
                        <p><b>Fecha de ingreso:</b> ${fechaIngreso || '—'}</p>
                        <p><b>Fecha de salida:</b> ${fechaSalida || '—'}</p>
                    `,
                    icon: "info",
                    confirmButtonText: "Cerrar",
                    confirmButtonColor: "#3085d6"
                });
            }
        });
    });

});
</script>

<script th:inline="javascript">
    // Mostrar/ocultar menú de perfil
    document.querySelector('.item-perfil').addEventListener('click', function(e) {
        e.stopPropagation();
        const menu = document.getElementById('menuPerfil');
        menu.classList.toggle('mostrar');
    });

    // Ocultar menú al hacer clic fuera
    document.addEventListener('click', function(e) {
        const menu = document.getElementById('menuPerfil');
        const perfilBtn = document.querySelector('.item-perfil');
        
        if (!menu.contains(e.target) && !perfilBtn.contains(e.target)) {
            menu.classList.remove('mostrar');
        }
    });

    function cerrarSesion() {
        const usuarioId = /*[[${usuarioActual.id}]]*/ null;
        
        if (usuarioId) {
            fetch('/cerrar_sesion_usuario/' + usuarioId, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (response.ok) {
                    window.location.href = '/login';
                } else {
                    console.error('Error al cerrar sesión');
                    window.location.href = '/login';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                window.location.href = '/login';
            });
        } else {
            window.location.href = '/login';
        }
    }
</script>
    </div>
  </body>
</html>